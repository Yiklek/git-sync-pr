name: Sync PR Bot

on:
  workflow_dispatch:
    inputs:
      pr_url:
        description: |
          PRé“¾æ¥åœ°å€ (GitHubæˆ–Gitee)
          ç¤ºä¾‹: https://github.com/owner/repo/pull/123
        required: true
        type: string
      personal_repo:
        description: |
          ä¸ªäººä»“åº“ (forkä»“åº“) (æ ¼å¼: owner/repo)
          ç”¨äºæ¨é€åˆ†æ”¯å’Œåˆ›å»ºPR
        required: false
        type: string
      patch_file:
        description: |
          æ˜¯å¦åˆ›å»º Format Patch
          éç©ºè¡¨ç¤ºåˆ›å»º Format Patch åˆ°æ–‡ä»¶
          ä»¥ "/" ç»“å°¾æ—¶ï¼Œè¡¨ç¤ºåœ¨ç›®å½•åˆ›å»º
        required: false
        type: string
      create_pr:
        description: |
          æ˜¯å¦è‡ªåŠ¨åˆ›å»ºPR
          å¦‚æœä¸ºtrueï¼Œå°†è‡ªåŠ¨åˆ›å»ºPR
        required: false
        type: boolean
        default: true
      target_branch:
        description: |
          ç›®æ ‡åˆ†æ”¯åç§°
          ç¤ºä¾‹: main, develop, release/v1.0
        required: false
        type: string
      target_repo:
        description: |
          ç›®æ ‡ä»“åº“ (æ ¼å¼: owner/repo)
          é»˜è®¤ä¸ºä¸æºPRç›¸åŒçš„ä»“åº“
        required: false
        type: string
      source_branch_name:
        description: |
          æºåˆ†æ”¯åç§°
          é»˜è®¤: è‡ªåŠ¨ç”Ÿæˆ (cherry-pick-pr-<prå·>-to-<ç›®æ ‡åˆ†æ”¯>)
        required: false
        type: string
      title_prefix:
        description: |
          PRæ ‡é¢˜å‰ç¼€
          é»˜è®¤: "Cherry-pick:"
        required: false
        type: string
      body_tail:
        description: |
          PRæè¿°å°¾éƒ¨ï¼Œå°†è¿½åŠ åˆ°PRæè¿°æœ«å°¾
        required: false
        type: string
        default: |
          This PR was created automatically. original PR: {pr_url}.
      dry_run:
        description: |
          æ¨¡æ‹Ÿè¿è¡Œæ¨¡å¼
          å¦‚æœä¸ºtrueï¼Œåªæ¨¡æ‹Ÿæ‰§è¡Œï¼Œä¸å®é™…æ‰§è¡Œæ“ä½œ
        required: false
        type: boolean
        default: false
      auto_confirm:
        description: |
          è‡ªåŠ¨ç¡®è®¤æ¨¡å¼
          å¦‚æœä¸ºtrueï¼Œè‡ªåŠ¨ç¡®è®¤æ‰€æœ‰æç¤ºï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
        required: false
        type: boolean
        default: true
      repo_path:
        description: |
          æœ¬åœ°Gitä»“åº“è·¯å¾„
          ä¸æŒ‡å®šåˆ™åœ¨ä¸´æ—¶ç›®å½•ä¸­å…‹éš†
        required: false
        type: string
      token_secret_name:
        description: |
          GitHub Tokençš„Secretåç§°
          éœ€è¦åœ¨ä»“åº“Settings -> Secrets and variables -> Actionsä¸­è®¾ç½®
          é»˜è®¤: GITHUB_TOKEN (GitHub Actionsè‡ªåŠ¨æä¾›çš„token)
        required: false
        type: string
        default: GITHUB_TOKEN
      git_user_name:
        description: |
          git user name
        required: true
        type: string
        default: GitHub Actions
      git_user_email:
        description: |
          git user email
        required: true
        type: string
        default: github-actions@github.com
      timeout_minutes:
        description: |
          å·¥ä½œæµè¶…æ—¶æ—¶é—´(åˆ†é’Ÿ)
          é»˜è®¤: 30åˆ†é’Ÿ
        required: false
        type: number
        default: 30

jobs:
  cherry-pick:
    runs-on: ubuntu-latest
    # timeout-minutes: ${{ github.event.inputs.timeout_minutes }}
    
    steps:
      - name: æ£€æŸ¥è¾“å…¥å‚æ•°
        run: |
          echo "=== è¾“å…¥å‚æ•°æ£€æŸ¥ ==="
          echo "PRé“¾æ¥: ${{ github.event.inputs.pr_url }}"
          echo "ä¸ªäººä»“åº“: ${{ github.event.inputs.personal_repo || 'æœªæŒ‡å®š' }}"
          echo "åˆ›å»ºFormat Patch: ${{ github.event.inputs.patch_file || 'No' }}"
          echo "åˆ›å»ºPR: ${{ github.event.inputs.create_pr }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo || 'æœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤' }}"
          echo "æºåˆ†æ”¯å: ${{ github.event.inputs.source_branch_name || 'æœªæŒ‡å®šï¼Œè‡ªåŠ¨ç”Ÿæˆ' }}"
          echo "æ ‡é¢˜å‰ç¼€: ${{ github.event.inputs.title_prefix || 'æœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤' }}"
          echo "æè¿°å°¾éƒ¨: ${{ github.event.inputs.body_tail || 'æœªæŒ‡å®š' }}"
          echo "Dry-runæ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          echo "è‡ªåŠ¨ç¡®è®¤: ${{ github.event.inputs.auto_confirm }}"
          echo "æœ¬åœ°ä»“åº“è·¯å¾„: ${{ github.event.inputs.repo_path || 'æœªæŒ‡å®šï¼Œä½¿ç”¨ä¸´æ—¶ç›®å½•' }}"
          echo "Tokenç¯å¢ƒå˜é‡: ${{ github.event.inputs.token_secret_name || 'æœªæŒ‡å®š' }}"
          #echo "è¶…æ—¶æ—¶é—´: ${{ github.event.inputs.timeout_minutes }}åˆ†é’Ÿ"
          
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7     

      - name: é…ç½®Git
        run: |
          echo "é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name ${{ github.event.inputs.git_user_name }}
          git config --global user.email ${{ github.event.inputs.git_user_email }}

          
          echo "é…ç½®Gitå®‰å…¨è®¾ç½®..."
          git config --global http.postBuffer 524288000
      
      - name: æ‰§è¡ŒSync PR
        env:
          # ä½¿ç”¨åŠ¨æ€çš„secretåç§°è·å–token
          TOKEN: ${{ secrets[github.event.inputs.token_secret_name] }}
        run: |
          echo "=== å¼€å§‹æ‰§è¡ŒSync PR ==="
          uv sync          
          # æ„å»ºåŸºæœ¬å‘½ä»¤
          CMD="uv run main.py"
          
          # æ·»åŠ å¿…éœ€å‚æ•°
          CMD="$CMD \"${{ github.event.inputs.pr_url }}\""
          
          # æ·»åŠ å¯é€‰å‚æ•°
          if [ -n "${{ github.event.inputs.repo_path }}" ]; then
            CMD="$CMD -r \"${{ github.event.inputs.repo_path }}\""
          fi
          
          if [ -n "${{ github.event.inputs.target_repo }}" ]; then
            CMD="$CMD --target-repo \"${{ github.event.inputs.target_repo }}\""
          fi
          
          if [ -n "${{ github.event.inputs.personal_repo }}" ]; then
            CMD="$CMD --personal-repo \"${{ github.event.inputs.personal_repo }}\""
          fi

          if [ -n "${{ github.event.inputs.patch_file }}" ]; then
            CMD="$CMD --patch \"${{ github.event.inputs.patch_file}}\""
          fi
          
          if [ "${{ github.event.inputs.create_pr }}" = "true" ]; then
            CMD="$CMD --create-pr"
          fi

          if [ -n "${{ github.event.inputs.target_branch }}" ]; then
            CMD="$CMD --target-branch \"${{ github.event.inputs.target_branch }}\""
          fi
          
          if [ -n "${{ github.event.inputs.source_branch_name }}" ]; then
            CMD="$CMD -s \"${{ github.event.inputs.source_branch_name }}\""
          fi
          
          if [ -n "${{ github.event.inputs.title_prefix }}" ]; then
            CMD="$CMD --title-prefix \"${{ github.event.inputs.title_prefix }}\""
          fi
          
          if [ -n "${{ github.event.inputs.body_tail }}" ]; then
            BODY_TAIL=$(echo -e "${{ github.event.inputs.body_tail }}")
            CMD="$CMD --body-tail \"$BODY_TAIL\""
          fi
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            CMD="$CMD --dry-run"
          fi
          
          if [ "${{ github.event.inputs.auto_confirm }}" = "true" ]; then
            CMD="$CMD -y"
          fi
          
          # æ·»åŠ tokenå‚æ•°
          if [ -n "${{ github.event.inputs.token_secret_name }}" ]; then
            CMD="$CMD --token-env-var TOKEN"
          else
            echo "âš ï¸ æœªæŒ‡å®štokenå‚æ•°ï¼Œå°†å°è¯•ä¸ä½¿ç”¨tokenæ‰§è¡Œ"
          fi
          
          echo "æ‰§è¡Œçš„å‘½ä»¤:"
          echo "$CMD"
          echo ""
          
          # æ‰§è¡Œå‘½ä»¤
          eval $CMD
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Sync PRæ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ Sync PRæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - uses: actions/upload-artifact@v6
        if: github.event.inputs.patch_file != ''
        with:
          name: pr
          path: ${{ github.event.inputs.patch_file }}

      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œç©ºé—´..."
          # æ¸…ç†å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
          find . -name "cherry_pick_*" -type d 2>/dev/null | xargs rm -rf || true
          
      - name: å®Œæˆé€šçŸ¥
        if: always()
        run: |
          echo "=== Sync PRå·¥ä½œæµå®Œæˆ ==="
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          echo "å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
          fi

